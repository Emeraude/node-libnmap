/* https://github.com/jas-/node-libnmap - License: MIT */
var version="v0.1.5",fs=require("fs"),async=require("async"),proc=require("child_process"),netmask=require("netmask").Netmask,nmap=function(e,t,n){"use strict";var r={nmap:"/usr/bin/nmap",scripts:"/usr/bin/nmap/scripts/",flags:"-n -oG -",range:"",ports:""};var i=i||{init:function(e){e=s.init(e);s.check(e);return{name:"node-libnmap",version:version,usage:"https://github.com/jas-/node-libnmap",license:"https://github.com/jas-/node-libnmap/blob/master/LICENSE",issues:"https://github.com/jas-/node-libnmap/issues",nmap:{legal:"http://nmap.org/book/man-legal.html"}}},scan:function(e,t){if(typeof e==="function"){t=e}e=s.init(e);e.flags=e.flags+" -T4";s.check(e);s.verify(e);var n=false,r=u.convert(e.range),i=[];async.map(r,function(t,r){e.range=t;n=u.command(e);var s=proc.exec(n);s.stdout.on("data",function(e){var t=u.report(e);if(t.length>0)i.push(t)});s.stdout.on("end",function(){r(null,i)})},function(e,n){t(e,n[0])})},discover:function(e,t){if(typeof e==="function"){t=e}e=s.init(e);e.flags=e.flags+" -sn";s.check(e);var n=s.adapters(),r=[],i=[],o=[],a={},f=false,l=0;async.map(n,function(t,n){a=t;o.push(a);r=u.calculate(t.properties.hosts,t.properties.range);async.map(r,function(n,r){var i=[];e.range=t.properties.cidr;e.range=n;f=u.command(e);proc.exec(f,r)},function(e,t){var r=t.join();i=u.neighbors(r);o[l].neighbors=i;l++;n(e,o)})},function(e,n){t(e,n[0])})}};var s=s||{check:function(e){if(Number(process.version.match(/^v\d+\.(\d+)/)[1])<11)throw new Error("Requires node.js v0.11.* and above");fs.exists(e.nmap,function(e){if(!e)throw new Error("nmap binary not found, install nmap")})},init:function(e){return u.merge(e,r)},verify:function(e){if(e.range){if(!/array|object/.test(typeof e.range))throw new Error("Range must be an array of host(s), examples:"+"[192.168.2.10 (single), 10.0.2.0/24 (CIDR), 10.0.10.5-20] (range)")}if(e.ports){if(!/^(?:(?:^|[-,])(?:[1-9][0-9]{0,3}|[1-5][0-9]{4}|6(?:[0-4][0-9]{3}|5(?:[0-4][0-9]{2}|5(?:[0-2][0-9]|3[0-5])))))+$/.test(e.ports))throw new Error("Port(s) must match one of the following examples:"+"512 (single) | 0-65535 (range) | 22-25,80,443,3306 (multiple)")}return true},interfaces:function(){var e=require("os").networkInterfaces(),t=[];for(var n in e){if(/array|object/.test(e[n])){for(var r in e[n]){if(/false/.test(e[n][r].internal)&&/ipv4/i.test(e[n][r].family)){var i={adapter:n,properties:e[n][r]};t.push(i)}}}}return t},adapters:function(){var e=[];this.interfaces().forEach(function(t){var n=new netmask(t.properties.address+"/"+t.properties.netmask);t.properties.cidr=n.base+"/"+n.bitmask;t.properties.hosts=n.size;t.properties.range={start:n.first,end:n.last};t.properties.raw=n;e.push(t)});return e}};var o=o||{net:{hostname:/^(([a-zA-Z]|[a-zA-Z][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z]|[A-Za-z][A-Za-z0-9\-]*[A-Za-z0-9])$/,IPv4:/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$/,IPv4CIDR:/(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([1-2]\d|3[0-2]|\d))/,IPv4Range:false,IPv6:/^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*/,IPv6CIDR:/^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*(\/(\d|\d\d|1[0-1]\d|12[0-8]))$/,IPv6Range:false},perform:function(e,t){return e.test(t)}};var u=u||{command:function(e){return!e.ports?e.nmap+" "+e.flags+" "+e.range:e.nmap+" "+e.flags+" "+" -p"+e.ports+" "+e.range},convert:function(e){var t=[],n=[],r=o.net,i=false;e.forEach(function(e){switch(true){case o.perform(r.hostname,e)||o.perform(r.IPv4,e)||o.perform(r.IPv6,e):t.push(e);break;case o.perform(r.IPv4CIDR,e)||o.perform(r.IPv6CIDR,e):i=new netmask(e);n=u.range(i);n.forEach(function(e){t.push(e)});break;default:break}});return t},range:function(e){var t=require("os").cpus().length,n=e.size/t,n=n>256?Math.round(n/255):n,r=[];e.forEach(function(e,t,i){if(i%n==0){var s=e.split("."),o=parseInt(s[3]),u=parseInt(s[3])+n-1,a=s[0]+"."+s[1]+"."+s[2]+"."+o+"-"+u;r.push(a)}});return r},calculate:function(e,t){var n=require("os").cpus().length,r=e/n,i=t.start.split("."),s=parseInt(i[3]),o=t.end.split("."),u=parseInt(o[3]),a=[],f=false;i.pop();o.pop();for(var l=s;l<u;l+=r){f=i[0]+"."+i[1]+"."+i[2]+"."+l+"-"+(l+(r-1)>256?l+(r-1):l+(r-1)-1);a.push(f)}return a},merge:function(e,t){e=e||{};for(var n in t){if(e.hasOwnProperty(n))t[n]=e[n];e[n]=t[n]}return e},neighbors:function(e){var t=e.split("\n"),n=[];t.forEach(function(e){if(/status: up/i.test(e))var t=/Host: (.*)\s\(\).*/g.exec(e);if(typeof t=="object")n.push(t[1])});return n},report:function(e){var t=e.split("\n"),n={},r=[];t.forEach(function(e){if(/ports:/i.test(e)){var t=e.split("	");if(t){t.forEach(function(e){if(/host/i.test(e)){var t=/host: (.*) \((.*)\)/ig.exec(e);if(t[1])n.ip=t[1];if(t[2])n.hostname=t[2]}if(/ports/i.test(e)){var r=/ports: (.*)/ig.exec(e),r=r[1].split(",");n.ports=u.ports(r)}});r.push(n)}}});return r},ports:function(e){var t=[];e.forEach(function(e){var n=e.split("/"),r={};r.port=n[0].trim();r.state=n[1];r.protocol=n[2];r.owner=n[3];r.service=n[4];r.rpc=n[5];r.version=n[6];t.push(r)});return t}};if(i[e]){return i[e].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof e==="object"||!e){return i.init.apply(this)}else{throw new Error('Method "'+e+'" does not exist, please see node-libnmap API')}};exports.nmap=nmap
